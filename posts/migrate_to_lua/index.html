<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>Neovim: 从VimScript迁移到Lua - Journeyman's Blog</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://example.comfavicon.png>
<link rel=stylesheet href=/css/style.min.4b2bfb3701049fe0da3e8d6b9d15186ba1dc7e294f0be3e2bca21bb8a330f5dd.css>
<meta name=description content="我如何把Neovim的init.vim迁移到Lua">
<meta property="og:title" content="Neovim: 从VimScript迁移到Lua">
<meta property="og:type" content="website">
<meta property="og:url" content="https://example.com/posts/migrate_to_lua/">
<meta property="og:image" content="https://example.com/images/cctv.jpeg">
<meta property="og:description" content="我如何把Neovim的init.vim迁移到Lua">
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@zerostaticio">
<meta name=twitter:creator content="@zerostaticio">
<link rel=preconnect href=https://fonts.gstatic.com>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet>
</head>
<body class="page frame page-blog-single">
<div id=wrapper class=wrapper>
<div class=header>
<a class=header-logo href=https://example.com>Journeyman's Blog</a>
<div class=menu-main>
<ul>
<li class=menu-item-about>
<a href=/pages/about/>About</a>
</li>
<li class=menu-item-posts>
<a href=/posts/>Posts</a>
</li>
</ul>
</div>
</div>
<div class=blog>
<div class=intro>
<h1>Neovim: 从VimScript迁移到Lua<span class=dot>.</span></h1>
<img src=/images/cctv.jpeg>
</div>
<div class=content>
<p>在迁移到neovim之后，我更喜欢模块化更好的Lua作为nvim的配置语言。虽然vimL我还没完全理解，例如函数（因为他奇怪的标志符和语法，还有我的懒）OK这虽然并不重要，但是在neovim势头正劲的情况下，生态的差距似乎正在拉开。我觉得及早转到neovim可能会更好融入这种生态。因为Lua是neovim生态的一等公民。</p>
<p>如何完整的迁移我仍在学习当中，但是这不妨碍我利用我已经学到的几点，在不牺牲我当前配置使用的情况下，我要把配置逐步取代为Lua。vim是个养成游戏，哎，就得这么玩。</p>
<p>所以这会是一个四不像的配置）</p>
<h2 id=入门----迁移options>入门 &ndash; 迁移Options</h2>
<p>没必要上来就把Lua怎么用看一遍，学过Python，会使用其他语言，直到什么叫脚本语言，完全可以随用随查。</p>
<p>我们先把options转换为Lua，相信Options也是当初学习配置Vim的第一步。 首先把创建一个<code>init.lua</code>。在里面对照你原来的Options写配置：</p>
<p>类似set xxx=yyy的配置，会被转换为vim.o.xxx</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-vimL data-lang=vimL><span class=nx>set</span> <span class=nx>expandtab</span><span class=p>=</span><span class=nx>false</span><span class=err>
</span></code></pre></div><p>将会被转换为</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=n>vim.bo</span><span class=p>.</span><span class=n>expandtab</span><span class=o>=</span><span class=kc>false</span>
</code></pre></div><p>注意，这里可能是以下三种之一，具体取决于你的Option是什么</p>
<ul>
<li><code>vim.o.xxx</code>（全局Option)</li>
<li><code>vim.wo.xxx</code>（window Option)</li>
<li><code>vim.bo.xxx</code>（Buffer Option)</li>
</ul>
<p>如何得知呢？键入<code>:help xxx</code> 去看一下，这是一个例子</p>
<p><img src=/images/show_expandtab.jpg alt=":help expandtab"></p>
<p>大多数Options都提到这个是什么类型，有的没有提到不过也不必慌，一会你<code>source init.lua</code>的时候，有错误他会提示你的。</p>
<p>值得注意的是，这里有一个小问题，数字，布尔这种类型可以直接转换过去，如果是类似encoding=UTF-8这种选项，记得把UTF-8加引号，like</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>vim.o.encoding=&#39;UTF-8&#39;
</code></pre></div><p>做到这里也许已经挺累了，记得使用宏帮助完成这些重复工作</p>
<h2 id=更深一步----mapping>更深一步 &ndash; mapping</h2>
<p>mapping更容易迁移，这是一个简单的例子，<code>vim.api.nvim_set_keymap</code> 是一个neovim暴露的接口，由于函数是Lua里的一等公民，可以引入到一个变量中后面使用。参数分别是：</p>
<ol>
<li>模式</li>
<li>映射前的键</li>
<li>映射后的键</li>
<li>选项
其中选项我几乎总是设置noremap，silent也可以设置，为了简单起见我们先使用同一种选项。</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=kd>local</span> <span class=n>keymap</span> <span class=o>=</span> <span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_keymap</span>
<span class=kd>local</span> <span class=n>opts</span> <span class=o>=</span><span class=p>{</span><span class=n>noremap</span><span class=o>=</span> <span class=kc>true</span><span class=p>,</span><span class=n>silent</span><span class=o>=</span><span class=kc>true</span><span class=p>}</span>
<span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span><span class=s1>&#39;H&#39;</span> <span class=p>,</span><span class=s1>&#39;^&#39;</span><span class=p>,</span><span class=n>opts</span><span class=p>)</span>
<span class=n>keymap</span><span class=p>(</span><span class=s1>&#39;n&#39;</span><span class=p>,</span><span class=s1>&#39;L&#39;</span><span class=p>,</span> <span class=s1>&#39;$&#39;</span><span class=p>,</span><span class=n>opts</span><span class=p>)</span>

</code></pre></div><p>BTW这里也可以使用宏来帮助快速完成这些迁移。</p>
<h2 id=使用packernvim来管理插件可选>使用packer.nvim来管理插件（可选）</h2>
<p>老实说，这是我更改的，或者今晚刚刚采用的插件，Vim-plug很好，资历很老而且几乎没有什么问题，Pakcer相对来说是个新家伙，只不过他可以提供插件懒加载，这对以后是有好处的。</p>
<p>这部分完全选做。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=c1>-- 这部分帮助你在自动下载所需的packers.nvim文件</span>
<span class=kd>local</span> <span class=n>fn</span> <span class=o>=</span> <span class=n>vim.fn</span>
<span class=kd>local</span> <span class=n>install_path</span> <span class=o>=</span> <span class=n>fn.stdpath</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>)</span><span class=o>..</span><span class=s1>&#39;/site/pack/packer/start/packer.nvim&#39;</span>
<span class=kr>if</span> <span class=n>fn.empty</span><span class=p>(</span><span class=n>fn.glob</span><span class=p>(</span><span class=n>install_path</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=kr>then</span>
  <span class=n>packer_bootstrap</span> <span class=o>=</span> <span class=n>fn.system</span><span class=p>({</span><span class=s1>&#39;git&#39;</span><span class=p>,</span> <span class=s1>&#39;clone&#39;</span><span class=p>,</span> <span class=s1>&#39;--depth&#39;</span><span class=p>,</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=s1>&#39;https://github.com/wbthomason/packer.nvim&#39;</span><span class=p>,</span> <span class=n>install_path</span><span class=p>})</span>
<span class=kr>end</span>

<span class=n>require</span><span class=p>(</span><span class=s1>&#39;packer&#39;</span><span class=p>).</span><span class=n>startup</span><span class=p>(</span><span class=kr>function</span><span class=p>(</span><span class=n>use</span><span class=p>)</span>
  <span class=c1>-- 有意思的是，packer可以用自己管理自己。</span>
  <span class=n>use</span> <span class=s1>&#39;wbthomason/packer.nvim&#39;</span>

  <span class=n>use</span> <span class=s1>&#39;tpope/vim-sensible&#39;</span>
  <span class=c1>-- your plugins here</span>

  <span class=kr>if</span> <span class=n>packer_bootstrap</span> <span class=kr>then</span>
    <span class=n>require</span><span class=p>(</span><span class=s1>&#39;packer&#39;</span><span class=p>).</span><span class=n>sync</span><span class=p>()</span>
  <span class=kr>end</span>
<span class=kr>end</span><span class=p>)</span>
</code></pre></div><p>使用<code>:PackerSync</code>更新插件</p>
<h2 id=妥协的部分>妥协的部分</h2>
<p>好了，说起来是容易的，真正调试完却并不容易。也许你已经想去喝杯咖啡了。然而望着你的四五个（甚至十几个二十几个）配置文件，你想：“我总不能先用一个残缺版的nvim吧，我已经做了那么多自定义了"。显然，一晚上是不够把所有的配置全部迁移过来的，另外还有一些配置只能用vimL，neovim内嵌lua还没有开放接口的，例如autocmd（PR还在review中）</p>
<p>那么接下来我们总要做一点妥协，让一部分继续以vimL的方式存在，也许此时你的init.lua中还有一部分没有修改。没关系，有一个接口帮助我们先延缓这些修改</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>vim.cmd</span><span class=p>()</span>
</code></pre></div><p>这个函数接受字符串，用来执行vimL，把来不及修改的地方，先用这个函数包裹。就可以先去喝一杯咖啡并且使用你已经配置好的nvim了。下面是一个例子。两个中括号<code>[[]]</code>是Lua跨行字符串的语法（类似Python中的"""）</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>vim.cmd</span><span class=p>(</span><span class=s>[[
</span><span class=s>autocmd FileType go let b:go_fmt_options = {
</span><span class=s>\ &#39;goimports&#39;: &#39;-local &#39; .
</span><span class=s>  \ trim(system(&#39;{cd &#39;. shellescape(expand(&#39;%:h&#39;)) .&#39; &amp;&amp; go list -m;}&#39;)),
</span><span class=s>\ }
</span><span class=s>]]</span><span class=p>)</span>
</code></pre></div><p>另外我还用这一段代码引入其他文件夹中的配置，如果你也只有一点时间，在引入Lua模块概念之前，可以这样粘合多个文件中配置。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=n>vim.cmd</span><span class=p>(</span><span class=s>[[
</span><span class=s>for f in split(glob(&#39;~/.config/nvim/config/*.vim&#39;), &#39;\n&#39;)
</span><span class=s>    exe &#39;source&#39; f
</span><span class=s>endfor
</span><span class=s>]]</span><span class=p>)</span>
</code></pre></div>
</div>
</div>
<div class=footer>
<div class=footer-social>
<span class="social-icon social-icon-github">
<a href=https://github.com/chivalryq title=github target=_blank rel=noopener>
<img src=/images/social/github.svg width=24 height=24 alt=github>
</a>
</span>
</div>
</div>
</div>
<script type=text/javascript src=/js/bundle.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js></script>
</body>
</html>